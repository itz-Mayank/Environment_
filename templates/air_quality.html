{% extends "base.html" %}

{% block title %}Air Quality{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="container">
    <!-- Search Form -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <div class="search-form">
                <form id="citySearchForm" method="GET" class="d-flex">
                    <input type="text" name="city" class="form-control me-2" placeholder="Enter city name (e.g., Delhi, Mumbai)" required>
                    <button type="submit" class="btn btn-primary">Search</button>
                </form>
            </div>
        </div>
    </div>

    {% if data %}
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-wind"></i> Air Quality Index
                    </h5>
                </div>
                <div class="card-body">
                    <div class="display-1 text-center mb-3 
                        {% if data.aqi <= 2 %}text-success
                        {% elif data.aqi <= 3 %}text-warning
                        {% else %}text-danger{% endif %}">
                        {{ data.aqi }}
                    </div>
                    <div class="text-center mb-4">
                        <span class="badge {% if data.aqi <= 2 %}bg-success{% elif data.aqi <= 3 %}bg-warning{% else %}bg-danger{% endif %}">
                            {% if data.aqi <= 2 %}Good
                            {% elif data.aqi <= 3 %}Moderate
                            {% else %}Poor{% endif %}
                        </span>
                    </div>

                    <!-- Health Recommendations -->
                    <div class="alert {% if data.aqi <= 2 %}alert-success{% elif data.aqi <= 3 %}alert-warning{% else %}alert-danger{% endif %}">
                        <h5>Health Advisory:</h5>
                        {% if data.aqi <= 2 %}
                        <p>Air quality is good. Perfect for outdoor activities!</p>
                        {% elif data.aqi <= 3 %}
                        <p>Sensitive individuals should limit prolonged outdoor exertion.</p>
                        {% else %}
                        <ul class="mb-0">
                            <li>Avoid outdoor activities</li>
                            <li>Wear N95 masks when going outside</li>
                            <li>Keep windows closed</li>
                            <li>Use air purifiers indoors</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- AQI Trend Graph -->
            <div class="graph-container">
                <h5 class="mb-3">AQI Trend (Last 7 Days)</h5>
                <div id="aqiChart" style="height: 400px;"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Additional Information
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>Temperature:</strong> {{ "%.1f"|format(data.temperature) }}°C</p>
                    <p><strong>Humidity:</strong> {{ data.humidity }}%</p>
                    <p><strong>Weather:</strong> {{ data.description|capitalize }}</p>
                    <p><strong>Last Updated:</strong> {{ last_updated }}</p>
                </div>
            </div>

            <!-- Map Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marked-alt"></i> Location
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 300px; border-radius: 0 0 12px 12px;"></div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center">
        <h4>Welcome to Air Quality Monitor!</h4>
        <p>Please search for a city to view its air quality data.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% if data and historical %}
<script>
    // Initialize map
    var map = L.map('map').setView([{{ lat }}, {{ lon }}], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Add AQI marker
    var marker = L.circle([{{ lat }}, {{ lon }}], {
        color: '{{ "#28a745" if data.aqi <= 2 else "#ffc107" if data.aqi <= 3 else "#dc3545" }}',
        fillColor: '{{ "#28a745" if data.aqi <= 2 else "#ffc107" if data.aqi <= 3 else "#dc3545" }}',
        fillOpacity: 0.5,
        radius: 2000
    }).addTo(map);
    marker.bindPopup("<b>AQI: {{ data.aqi }}</b><br>{{ location }}").openPopup();

    // Create time series data for graphs
    const timeSeriesData = {
        dates: {{ historical.dates|tojson }},
        aqi: {{ historical.aqi|tojson }}
    };

    // Initialize graphs
    createTimeSeriesGraphs(timeSeriesData);
</script>
{% endif %}
{% endblock %}