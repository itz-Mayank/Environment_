{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">Environmental Sustainability Dashboard</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            {% if location %}
                            <li class="breadcrumb-item active">{{ location }}</li>
                            {% endif %}
                        </ol>
                    </nav>
                </div>
                <div class="text-end">
                    <div class="text-muted mb-2">Last updated: {{ last_updated }}</div>
                    <form id="citySearchForm" method="GET" class="d-flex">
                        <input type="text" name="city" class="form-control me-2" placeholder="Search city..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if data %}
    <!-- AQI Overview Section -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-wind me-2"></i>Air Quality Index
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="display-1 mb-3 
                            {% if data.aqi <= 50 %}text-success
                            {% elif data.aqi <= 100 %}text-warning
                            {% elif data.aqi <= 150 %}text-orange
                            {% elif data.aqi <= 200 %}text-danger
                            {% else %}text-purple{% endif %}">
                            {{ data.aqi }}
                        </div>
                        <div class="aqi-status mb-3">
                            <span class="badge 
                                {% if data.aqi <= 50 %}bg-success
                                {% elif data.aqi <= 100 %}bg-warning
                                {% elif data.aqi <= 150 %}bg-orange
                                {% elif data.aqi <= 200 %}bg-danger
                                {% else %}bg-purple{% endif %}">
                                {% if data.aqi <= 50 %}Good
                                {% elif data.aqi <= 100 %}Moderate
                                {% elif data.aqi <= 150 %}Unhealthy for Sensitive Groups
                                {% elif data.aqi <= 200 %}Unhealthy
                                {% else %}Very Unhealthy{% endif %}
                            </span>
                        </div>
                        <div class="aqi-description small">
                            {% if data.aqi <= 50 %}
                            Air quality is satisfactory, and air pollution poses little or no risk.
                            {% elif data.aqi <= 100 %}
                            Air quality is acceptable. However, there may be a risk for some people.
                            {% elif data.aqi <= 150 %}
                            Members of sensitive groups may experience health effects.
                            {% elif data.aqi <= 200 %}
                            Everyone may begin to experience health effects.
                            {% else %}
                            Health alert: everyone may experience more serious health effects.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>AQI Trend
                    </h5>
                </div>
                <div class="card-body">
                    <div id="aqiTrendChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pollutant Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-microscope me-2"></i>Pollutant Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="pollutant-card text-center p-3">
                                <h6>PM2.5</h6>
                                <div class="display-6">{{ data.pollutants.pm25 }}</div>
                                <div class="small text-muted">μg/m³</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="pollutant-card text-center p-3">
                                <h6>PM10</h6>
                                <div class="display-6">{{ data.pollutants.pm10 }}</div>
                                <div class="small text-muted">μg/m³</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="pollutant-card text-center p-3">
                                <h6>NO2</h6>
                                <div class="display-6">{{ data.pollutants.no2 }}</div>
                                <div class="small text-muted">ppb</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="pollutant-card text-center p-3">
                                <h6>SO2</h6>
                                <div class="display-6">{{ data.pollutants.so2 }}</div>
                                <div class="small text-muted">ppb</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="pollutant-card text-center p-3">
                                <h6>CO</h6>
                                <div class="display-6">{{ data.pollutants.co }}</div>
                                <div class="small text-muted">ppm</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="pollutant-card text-center p-3">
                                <h6>O3</h6>
                                <div class="display-6">{{ data.pollutants.o3 }}</div>
                                <div class="small text-muted">ppb</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Climate and Weather Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-thermometer-half me-2"></i>Climate Metrics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="text-center mb-4">
                                <h6>Temperature</h6>
                                <div class="display-4">{{ "%.1f"|format(data.temperature) }}°C</div>
                                <p class="text-muted">{{ data.description }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center mb-4">
                                <h6>Humidity</h6>
                                <div class="display-4">{{ data.humidity }}%</div>
                                <p class="text-muted">Relative Humidity</p>
                            </div>
                        </div>
                    </div>
                    <div id="tempTrendChart" style="height: 200px;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marked-alt me-2"></i>Location Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div id="map" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Advisory Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Health Advisory</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Sensitive Groups</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-child me-2"></i>Children</li>
                                <li><i class="fas fa-user-plus me-2"></i>Elderly</li>
                                <li><i class="fas fa-lungs me-2"></i>Asthma Patients</li>
                                <li><i class="fas fa-heart me-2"></i>Heart Patients</li>
                            </ul>
                        </div>
                        <div class="col-md-8">
                            <h6>Recommendations</h6>
                            <div class="alert {% if data.aqi <= 50 %}alert-success
                                        {% elif data.aqi <= 100 %}alert-warning
                                        {% elif data.aqi <= 150 %}alert-orange
                                        {% else %}alert-danger{% endif %}">
                                {% if data.aqi <= 50 %}
                                <ul class="mb-0">
                                    <li>Enjoy outdoor activities</li>
                                    <li>Perfect air quality for all groups</li>
                                    <li>Continue normal activities</li>
                                </ul>
                                {% elif data.aqi <= 100 %}
                                <ul class="mb-0">
                                    <li>Sensitive individuals should limit prolonged outdoor exposure</li>
                                    <li>Keep windows closed during peak pollution hours</li>
                                    <li>Consider wearing masks outdoors</li>
                                </ul>
                                {% else %}
                                <ul class="mb-0">
                                    <li>Avoid outdoor activities</li>
                                    <li>Wear N95 masks when going outside</li>
                                    <li>Use air purifiers indoors</li>
                                    <li>Keep windows closed</li>
                                </ul>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-info text-center">
        <h4>Welcome to Environmental Sustainability Monitor!</h4>
        <p>Please search for a city to view environmental data and sustainability metrics.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .bg-orange {
        background-color: #fd7e14 !important;
    }
    .bg-purple {
        background-color: #6f42c1 !important;
    }
    .pollutant-card {
        background-color: #f8f9fa;
        border-radius: 10px;
        transition: transform 0.3s ease;
    }
    .pollutant-card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% if data and historical %}
<script>
    // Initialize map
    var map = L.map('map').setView([{{ lat }}, {{ lon }}], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Add AQI marker
    var aqiColor = '{{ "#28a745" if data.aqi <= 50 else "#ffc107" if data.aqi <= 100 else "#fd7e14" if data.aqi <= 150 else "#dc3545" }}';
    var airQualityMarker = L.circle([{{ lat }}, {{ lon }}], {
        color: aqiColor,
        fillColor: aqiColor,
        fillOpacity: 0.5,
        radius: 2000
    }).addTo(map);
    airQualityMarker.bindPopup(`
        <b>${{ location }}</b><br>
        AQI: {{ data.aqi }}<br>
        Temperature: {{ data.temperature }}°C<br>
        Humidity: {{ data.humidity }}%
    `).openPopup();

    // Create time series data
    const timeSeriesData = {
        dates: {{ historical.dates|tojson }},
        temperatures: {{ historical.temperatures|tojson }},
        aqi: {{ historical.aqi|tojson }},
        humidity: {{ historical.humidity|tojson }}
    };

    // Initialize trend graphs
    createTimeSeriesGraphs(timeSeriesData);
</script>
{% endif %}
{% endblock %}